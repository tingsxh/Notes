## 分布式笔记

### 分布式一致性协议

* 在一致性协调的框架中，一般会涉及到一个协调者，以及其他多个执行者。当一个事务被分成多个事务且分散在多个节点上执行时，如何保证事务的一致性？

#### 两段式提交

* **阶段一：**

  提交事务执行请求，协调者首先向各参与者发起执行事务的请求，然后等待个参与者的响应信息

  * 参与者开始执行，并且记录UNDO 日志，如果参与者执行ok 则向协调者发出 YES 的响应，如果执行失败则发送 NO
  * 协调者如果收到所有参与者都返回了OK ,或者 有一个返回NO 或者 等待任何一个参与者响应超时，则会直接进入第二阶段。

* **阶段二：**

  提交事务请求，协调者根据各个参与者的响应信息来决定是否提交事务，或者进行回滚，参与则提交或者回滚成功，则返回协调者 执行OK, 协调者判断该次事务结束。

* 缺点：

  * 容错性差，如果其中协调者挂了，则所有参与者都阻塞在等待提交的过程中而无法处理其他事务。
  * 会出现数据不一致的情况，如果在提交过程中，有一部分参与者提交失败，则此时便处于不一致的情况。

#### 三段式提交

* 相比于二阶段提交来说，三阶段提交是把 提交事务执行请求分为了两个阶段，即 事务执行询问+事务执行预提交。

* **阶段一**

  协调者会向各个参与者发起一个canCommit 的询问请求，参与者根据自身情况决定是返回的响应值。

* **阶段二**

  如果阶段一 所有参与者都返回 YES 响应的话，则会提交事务执行请求，如果有返回为 NO 或者等待超时的参与者则会直接执行事务中断请求。

  如果参与者无论收到了 abort 的中断请求，还是等待协调者出现超时的情况，自身都会执行中断事务的操作。如果参与者成功执行，则向协调者返回YES 响应。

* **阶段三**

  如果在执行阶段二之后，所有参与则都响应YES, 则执行事务提交。如果有响应超时或者返回NO 的参与者，则执行事务中断操作。

  当阶段三的doCommit 或者 abort 事件没有传达到 参与者，参与者依然会战哎等待超时之后继续执行提交事务。

* **优缺点**

  参与者自身具有等待超时的降级机制，不会出现长时间阻塞了。

  缺点就是，也可能造成数据不一致的情况。

#### Paxos 协议



### ZookeePer

* Leader 、Follwer、Observer

#### 前提知识

* leader 节点每次接收到客户端的事务请求之后，都会生成一个全局递增的事务ID ZXID，作为此次事务的一个标识。
* leader 会与每一个follower 维护一个队列，按照事务的先后顺序分发给follower节点。

### ZAB 协议

#### 消息广播机制

* 首先当 leader 接收到一个事务请求之后，在本机执行的同时会将该事务广播给其他follwer 节点，然后等待follower 节点的响应。
* leader 不需要等到所有的follower节点都返回，只需要超过一半的节点**包括leader节点本身** 返回，那么就会将提交的请求发送给所有的follower ，同时其自身也会将事务进行提交。

#### 崩溃恢复机制

* 消息崩溃机制主要需要解决如下两种问题：
* 情况一：当leader节点接收到客户端的请求，自身执行完成之后 然后leader节点出现崩溃，ZAB 协议需要保障重新选举出来的新的Leader 节点需要丢弃该事务。
* 情况二：当leader节点接收到客户端请求之后，并且事务执行已经成功广播给各个子节点，当需要执行事务A提交的时候，只发送了提交请求给一部分follower节点，此时就需要保证所有其他节点都能够执行该事务的提交，否则就会出现不一致的情况。

**如何选举出新的Leader节点**

* zab 协议将会从所有的Follower节点中选举出一个 拥有 最大 ZXID 提交记录的节点，那么可以确保该Leader 拥有所有已经提交过的事务记录。
* 





