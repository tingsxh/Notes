## 一致性HASH 算法

### 普通hash 算法

* 当数据量过大的时候，需要对数据库进行分布式部署的时候，比如部署在A,B,C 三台机器上，那么数据需要存放在哪台机器上 一般会采用HASH 来决定，比如根据数据A 取hash 值得到HASH 值 HASHA ,然后再使用HASHA 对机器数量 3 进行取模，得到的值便是需要存储的机器号。

### 产生的问题

* 使用普通的hash 算法进行计算存储机器的时候会遇到很多问题，比如当下线一台机器，或者新增了一台机器的时候，再使用取模算法就会导致获取不到数据了。几乎所有的缓存数据都需要重新计算。

### 一致性hash算法

* 新的一致性hash 算法不再是对机器数量进行取模了，而是对 2^32 进行取模，所有取模后的数据将分布再0~2^32 -1 之间。
* 首先先将机器 A,B,C 的ip 或者机器名称进行取模，得到他们在0-2^32 之间的位置。
* 然后再对数据进行HASH 之后取模，假设得到数据K ,再将K 顺时针寻找，直到找到第一个机器，然后数据就存储再这台机器上。
* 这样的好处就是，无论是新增机器还是下线机器，都只会影响一小部分数据。

### 一致性hash 算法的缺陷

* 当机器数量过少的时候容易产生数据分布不均匀的情况，比如只有两台机器的情况下，会出现如下的情况：
*  ![img](https://pic3.zhimg.com/80/v2-d499324a9aa067915bbb3f5f3416b032_720w.jpg) 

* 解决的办法是采用虚拟节点的方法，比如A,节点可以虚拟出 A1,A2,A3 ,A4 这几个节点，然后进行hash ，最后只需要再做一层 A1-->A 的映射即可。
